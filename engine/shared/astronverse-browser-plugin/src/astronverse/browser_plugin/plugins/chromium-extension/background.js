const log_info=(...e)=>{console.log("[info]",...e)},log_time=e=>{console.time(e)},log_timeEnd=e=>{console.timeEnd(e)};function gen_short_id(){return"xxxxxxxx".replace(/[x]/g,(function(){return(16*Math.random()|0).toString(16)}))}function gen_time(){return Math.floor((new Date).getTime()/1e3)}function default_log(e){console.info("[info]",e)}class e{constructor(e=void 0,t=void 0,a=void 0,n=void 0,r=void 0,s=void 0,i=void 0,c=void 0,o=void 0){this.reply_event_id=e,this.event_id=t,this.event_time=a,this.channel=n,this.key=r,this.uuid=s,this.send_uuid=i,this.need_ack=c,this.data=o}to_reply(){let t=new e;return t.reply_event_id=this.event_id,t.channel=this.channel,t.key=this.key,t.uuid=this.send_uuid,t.send_uuid=this.uuid,t.need_ack=this.need_ack,t.data=void 0,t.init()}init(){return this.event_id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),this.event_time=gen_time(),this}tojson(){return JSON.stringify(this)}}class t extends Error{}class a extends t{}class n extends t{}const r=new e;r.channel="ping";const s=new e;s.channel="pong";const i=new e;i.channel="exit";const c=new e;c.channel="ack";class o{constructor(e,t,a){this.channel=e,this.key=t,this.func=a}}class l{constructor(e,t,a=void 0,n=0){this.watch_type=e,this.watch_key=t,this.callback=a,this.retry_time=n,this.interval=10,this.time=0,this.timeout=0}init(e){return this.interval=e,this.timeout=gen_time()+this.interval,this}retry(){this.time+=1,this.timeout+=this.interval}}class d{constructor(e,t=30,a=10,n=20,r=default_log){this.url=e,this.log=r,this.ws_app=void 0,this.running=!1,this.ping_interval=t,this.routes={},this.reconnect_time=0,this.reconnect_interval=a,this.reconnect_max_time=n,this.watch_interval=1,this.watch_msg={},this.watch_msg_queue=[],this.start_ping_task=void 0}_send_text(e){this.ws_app&&this.ws_app.send(e.tojson())}_call_route(e,a,n){let r=`${e}$$${a}`,s=`${e}$$`;if(r in this.routes){return(0,this.routes[r].func)(n)}if(s in this.routes){return(0,this.routes[s].func)(n)}throw new t(`func is not exist: ${e} ${a}`)}_call_watch(e,t,a){null!=e.callback&&e.callback(t,a)}event(e,t,a){let n=`${e}$$${t}`;this.routes[n]=new o(e,t,a)}_add_watch(e){let t=`${e.watch_type}$$${e.watch_key}`;this.watch_msg[t]=e,this.watch_msg_queue.push({time:e.timeout,name:t}),this.watch_msg_queue.sort(((e,t)=>e.time-t.time))}_clear_watch(){setTimeout((()=>{for(;this.running&&this.watch_msg_queue.length>0;){let t=gen_time();if(this.watch_msg_queue[0].time>t)break;try{let e=this.watch_msg_queue[0].name;if(this.watch_msg_queue.shift(),e in this.watch_msg){let t=this.watch_msg[e];t.retry(),t.time>t.retry_time?(this._call_wait(t,void 0,n("watch timeout")),delete this.watch_msg[e]):(this._call_wait(t,void 0,a("retry")),this.watch_msg_queue.push({time:t.timeout,name:e}),this.watch_msg_queue.sort(((e,t)=>e.time-t.time)))}}catch(e){this.log(`error _clear_watch: ${e}`)}}this._clear_watch()}),1e3*this.watch_interval)}_close_watch(){this.watch_msg={},this.watch_msg_queue=[]}_start_ping(){this.start_ping_task=setInterval((()=>{this.running&&(this.log(this.url),this._send_text(r))}),1e3*this.ping_interval)}_close_ping(){clearInterval(this.start_ping_task),this.start_ping_task=void 0}send(e){(()=>{this._send_text(e)})()}send_reply(e,t,a,n=void 0){this._add_watch(new l("reply",e.event_id,((e,t)=>{null==t?a(e):n&&n(t)})).init(t)),this.send(e)}_on_message(){let t=this;return function(a){let n=JSON.parse(a.data),r=new e(n.reply_event_id,n.event_id,n.event_time,n.channel,n.key,n.uuid,n.send_uuid,n.need_ack,n.data);setTimeout((function(){if(r.channel==s.channel)return;if(r.channel==c.channel){let e=`ack$$${r.event_id}`;if(e in t.watch_msg){let a=t.watch_msg[e];t._call_wait(a,r,void 0),delete t.watch_msg[e]}return}if(r.channel==i.channel)return void t.log(`error ExitMsg: ${r.tojson}`);if(r.reply_event_id){let e=`reply$$${r.reply_event_id}`;if(e in t.watch_msg){let a=t.watch_msg[e];t._call_watch(a,r,void 0),delete t.watch_msg[e]}return}let e=r.to_reply();try{let a=t._call_route(r.channel,r.key,r);e.data=a}catch(a){e.data=String(a)}try{null!=e.data&&t.send(e)}catch(a){t.log(`error _call_route: ${a}`)}}),0)}}_on_open(){let e=this;return function(t){e.running=!0,e._start_ping(),e._clear_watch();try{e._call_route("open","",void 0)}catch(a){e.log(`error _on_open _call_route: ${a}`)}}}_on_close(){let e=this;return function(t){e.running=!1,e._close_ping(),e._close_watch(),e.ws_app=void 0;try{e._call_route("close","",void 0)}catch(a){e.log(`error _on_close _call_route: ${a}`)}e._reconnect()}}_on_error(){let e=this;return function(t){try{e._call_route("error","",void 0)}catch(a){e.log(`error _on_error _call_route: ${a}`)}e.log(`error _on_error:${t}`)}}_reconnect(){setTimeout((()=>{(-1===this.reconnect_max_time||this.reconnect_time<this.reconnect_max_time)&&(this.reconnect_time+=1,this.log(`_reconnect star: ${this.reconnect_time}`),this.start(),this.log(`_reconnect end: ${this.reconnect_time}`))}),1e3*this.reconnect_interval)}start(){let e=this;try{this.ws_app=new WebSocket(this.url),this.ws_app.onopen=this._on_open(),this.ws_app.onmessage=this._on_message(),this.ws_app.onclose=this._on_close(),this.ws_app.onerror=this._on_error()}catch(t){e.log(`error start: ${t}`)}}}const u="$firefox$"===function(){const e=/Chrome/.test(navigator.userAgent),t=/Firefox/.test(navigator.userAgent),a=/Edg/.test(navigator.userAgent);return t?"$firefox$":a?"$edge$":e?"$chrome$":"$unknown$"}()?browser.storage.local:chrome.storage.local;async function createWsApp(){const{cid:e=gen_short_id()}=await u.get("cid");await u.set({cid:e});const t="$chromium$";console.info("token:",t);const a=btoa(t),n=function(){const e=navigator.userAgentData;let t="unknown";if(e&&e.brands)for(const a of e.brands)"Chromium"===a.brand&&(t=a.version);return t}();return new d(`ws://127.0.0.1:9082/ws?token=${a}&nv=${n}&cid=${e}`,10,10,-1)}chrome.runtime.id;var m=(e=>(e.SUCCESS="0000",e.UNKNOWN_ERROR="5001",e.ELEMENT_NOT_FOUND="5002",e.EXECUTE_ERROR="5003",e.VERSION_ERROR="5004",e))(m||{}),h=(e=>(e.TAB_GET_ERROR="获取标签页失败",e.ACTIVE_TAB_ERROR="未找到活动标签页",e.NUMBER_ID_ERROR="id 必须是数字",e.FRAME_GET_ERROR="未找到元素对应的iframe",e.CURRENT_TAB_UNSUPPORT_ERROR="当前标签页不支持web拾取协议",e.NOT_SIMILAR_ELEMENT="该元素不是相似元素",e.SIMILAR_NOT_FOUND="未找到相似元素",e.RELATIVE_ELEMENT_PARAMS_ERROR="关联元素参数错误",e.ELEMENT_NOT_FOUND="未找到元素",e.UNSUPPORT_ERROR="暂未实现",e.PARAMS_URL_NOT_FOUND="缺少url字段！",e.PARAMS_NAME_NOT_FOUND="缺少name字段！",e.PARAMS_NAME_VALUE_NOT_FOUND="缺少必填字段name, value！",e.CONTEXT_NOT_FOUND="未找到执行上下文，请确保页面已加载完成",e.EXECUTE_ERROR="执行失败，未获取到结果",e.DEBUGGER_TIMOUT="检测 Debugger 状态超时",e.CONTENT_MESSAGE_ERROR="内容脚本消息响应错误",e))(h||{}),g=(e=>(e.DELETE_SUCCESS="删除成功",e.SET_SUCCESS="设置成功",e.EMPTY_SUCCESS="清空成功",e))(g||{});const w={getNavigatorUserAgent(){const e=/Chrome/.test(navigator.userAgent),t=/Firefox/.test(navigator.userAgent),a=/Edg/.test(navigator.userAgent);return t?"$firefox$":a?"$edge$":e?"$chrome$":"$unknown$"},wait:async e=>new Promise((t=>{setTimeout(t,1e3*e)})),removeUrlParams:e=>e.replace(/\?.*$/,""),isEndWithSlash:e=>e.endsWith?e.endsWith("/"):"/"===e.substr(-1),stringToRegex(e){let t=e,a="";const n=e.lastIndexOf("/");e.startsWith("/")&&n>0&&(t=e.slice(1,n),t.startsWith("^")&&t.endsWith("$")&&(t=t.slice(1,-1)),(t.includes("\\d")||t.includes("\\w")||t.includes("\\s")||t.includes("\\b")||t.includes("\\.")||t.includes("\\*")||t.includes("\\?")||t.includes("\\+")||t.includes("\\{")||t.includes("\\}")||t.includes("\\[")||t.includes("\\]"))&&(t=t.replace(/\\/g,"\\")),a=e.slice(n+1));try{return new RegExp(t,a)}catch{throw new Error("Invalid regular expression pattern")}},isSupportProtocal:e=>!!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("ftp://")||e.startsWith("file://")),isNumberStartString:e=>/^\d/.test(e),isNumberString:e=>/\d/.test(e),isSpecialCharacter(e){return!!this.isNumberStartString(e)||!!/[~`!@#$%^&*()+\-={}\\[\]|:;"'<>,.?/（）￥！、；：“”‘’【】《》，。？]/.test(e)},success:(e,t="success")=>({code:m.SUCCESS,data:e,msg:t}),fail:(e="failed",t=m.UNKNOWN_ERROR)=>({data:null,code:t,msg:e}),result:(e,t="success",a=m.SUCCESS)=>({code:a,data:e,msg:t})},_={getCookie:e=>new Promise((t=>{e.url||t(w.fail(h.PARAMS_URL_NOT_FOUND)),e.path?(e.domain=new URL(e.url).hostname,delete e.url):delete e.path,chrome.cookies.getAll({...e},(e=>{Array.isArray(e)&&e.length?t(w.success(e[0])):t(w.success(null))}))})),removeCookie:e=>new Promise((t=>{e.url||t(w.fail(h.PARAMS_URL_NOT_FOUND)),e.name||t(w.fail(h.PARAMS_NAME_NOT_FOUND)),chrome.cookies.remove(e,(()=>{t(w.success(g.DELETE_SUCCESS))}))})),setCookies:e=>new Promise((t=>{e.url||t(w.fail(h.PARAMS_URL_NOT_FOUND)),e.name&&e.value||t(w.fail(h.PARAMS_NAME_VALUE_NOT_FOUND)),chrome.cookies.set(e,(()=>{t(w.success(g.SET_SUCCESS))}))})),getAllCookies:e=>new Promise((t=>{""!==e.path?(e.domain=new URL(e.url).hostname,delete e.url):delete e.path,chrome.cookies.getAll(e,(e=>{t(w.success(e))}))})),emptyCookies:e=>new Promise((t=>{_.getAllCookies(e).then((e=>{const a=e.data;if(Array.isArray(a)&&a.length){const e=a.map((e=>{const t=`http${e.secure?"s":""}://${e.domain.startsWith(".")?e.domain.slice(1):e.domain}${e.path}`;return _.removeCookie({url:t,name:e.name})}));Promise.all(e).then((()=>{t(w.success(g.EMPTY_SUCCESS))}))}else t(w.success(g.EMPTY_SUCCESS))}))}))};class f{data;produceType;constructor(e,t,a){if(this.produceType=a,"table"===a&&(this.data={...e,produceType:a,values:t}),"similar"===a){const n={...e,value:t};this.data={produceType:a,values:[n]}}}getTable(){return this.data}isSimilarDataType(){return"similar"===this.produceType}}function getSimilarElement(e,t){if(!function(e,t){const{cssSelector:a,pathDirs:n}=e,{cssSelector:r,pathDirs:s}=t,i=a.split(">"),c=r.split(">");if(e.url!==t.url)return!1;if(i.length!==c.length)return!1;if(n.length!==s.length)return!1;if(n.length===s.length)for(let o=0;o<n.length;o++)if(n[o].tag!==s[o].tag)return!1;return!0}(e,t))return!1;const a=function(e,t){if(e===t)return e;const a=e.split("/"),n=t.split("/");for(let s=0;s<a.length;s++)a[s]!==n[s]&&(a[s]=a[s]?.split("[")[0]);const r=a.join("/");return r}(e.xpath,t.xpath),n=function(e,t){if(e===t)return e;const a=e.split(">"),n=t.split(">");for(let r=0;r<a.length;r++)a[r]!==n[r]&&a[r].includes(":nth-child")&&(a[r]=a[r].split(":nth-child")[0]),a[r]!==n[r]&&a[r].includes(".")&&(a[r]=a[r].split(".")[0]),a[r]!==n[r]&&a[r].includes("#")&&(a[r]=a[r].split("#")[0]);return a.join(">")}(e.cssSelector,t.cssSelector),r=function(e,t){for(let a=e.length-1;a>=0;a--){const n=e[a],r=t[a];n.attrs.forEach((e=>{const t=r.attrs.find((t=>t.name===e.name));if(t){const a=t.type===e.type,n=String(e.value)===String(t.value)&&""!==e.value;e.checked=!(!n||!a)&&(t.checked&&e.checked),"innertext"!==t.name&&"text"!==t.name||(e.checked=!1,e.value="")}else e.value="",e.checked=!1}))}return e}(e.pathDirs,t.pathDirs);return{...e,xpath:a,cssSelector:n,pathDirs:r}}const E="$firefox$"===w.getNavigatorUserAgent(),b={attached:!1,tabId:0,frameContextIdMap:{0:[]},enableRuntime:e=>new Promise(((t,a)=>{chrome.debugger.sendCommand({tabId:e},"Runtime.enable",{},(()=>{chrome.runtime.lastError?(console.error(chrome.runtime.lastError),a(chrome.runtime.lastError)):t(!0)}))})),attachDebugger:e=>new Promise(((t,a)=>{if(b.attached)return a(new Error("Debugger is already attached to a tab"));chrome.debugger.attach({tabId:e},"1.3",(()=>{chrome.runtime.lastError?(console.error(chrome.runtime.lastError),a(chrome.runtime.lastError)):(log_info("Debugger attached successfully"),b.tabId=e,b.attached=!0,t(!0))}))})),detachDebugger:e=>new Promise((t=>{chrome.debugger.detach({tabId:e},(()=>{log_info("Debugger detached successfully"),b.attached=!1,b.frameContextIdMap={0:[]},t(!0)}))})),getFrameTree:async e=>new Promise(((t,a)=>{chrome.debugger.sendCommand({tabId:e},"Page.getFrameTree",{},(e=>{chrome.runtime.lastError?(console.error(chrome.runtime.lastError),a(chrome.runtime.lastError)):t(e)}))})),evaluate:async(e,t,a)=>{t=`(function() { ${t} })()`,await b.attachDebugger(e),await b.enableRuntime(e),await w.wait(1);const n=b.frameContextIdMap[a]||[];if(!n.length)throw new Error(h.CONTEXT_NOT_FOUND);const r=n?.map((a=>chrome.debugger.sendCommand({tabId:e},"Runtime.evaluate",{expression:t,contextId:a}))),s=await Promise.all(r),i=s.find((e=>!e.exceptionDetails)),c=s.find((e=>e.exceptionDetails));if(log_info("evaluate successRes: ",i,"evaluate failRes: ",c),await b.detachDebugger(e),i)return i.result.value||"";throw c?new Error(c.result.description):new Error(h.EXECUTE_ERROR)}};E||(chrome.debugger.onEvent.addListener((async(e,t,a)=>{if(e.tabId!==b.tabId)return;if("Runtime.consoleAPICalled"!==t||"log"!==a.type||!a.args?.length)return;const n=a.args[0]?.value||"",r=a.executionContextId;if(n.includes("rpa_debugger_on")){const e=`${n.split(":")[1]}`;b.frameContextIdMap[e]||(b.frameContextIdMap[e]=[r]),b.frameContextIdMap[e].includes(r)||b.frameContextIdMap[e].push(r)}})),chrome.debugger.onDetach.addListener((()=>{b.attached=!1})));const p="jpeg";async function captureFullPage(e){let t;if("$firefox$"===w.getNavigatorUserAgent())return t=await function(e){return new Promise((t=>{chrome.tabs.sendMessage(e.id,{key:"fullPageRect",data:{}},{frameId:0},(a=>{browser.tabs.captureTab(e.id,{format:p,quality:92,rect:a}).then((e=>{t(e)}))}))}))}(e),t;await attach(e.id,null,e),await enablePage(e.id),await setBg(e.id,{color:{r:255,g:255,b:255,a:1}});const{cssContentSize:{width:a,height:n}}=await(r=e.id,new Promise((e=>{chrome.debugger.sendCommand({tabId:r},"Page.getLayoutMetrics",{},e)})));var r;return await function(e,{height:t,width:a}){return new Promise((n=>{chrome.debugger.sendCommand({tabId:e},"Emulation.setDeviceMetricsOverride",{height:t,width:a,deviceScaleFactor:1,mobile:!1},n)}))}(e.id,{height:n,width:a}),await sleep(500),t=await screenshot(e.id,{x:0,y:0,width:a,height:n}),await sleep(500),await clearSize(e.id),await detach(e.id),t}function clearSize(e){return new Promise((t=>{chrome.debugger.sendCommand({tabId:e},"Emulation.clearDeviceMetricsOverride",t)}))}function screenshot(e,t){return new Promise(((a,n)=>{chrome.debugger.sendCommand({tabId:e},"Page.captureScreenshot",{format:p,fromSurface:!0,quality:92,clip:{...t,scale:1}},(e=>{if(chrome.runtime.lastError)n(chrome.runtime.lastError);else{const t=`data:image/${p};base64,${e.data}`;a(t)}}))}))}function setBg(e,t){return new Promise((a=>{chrome.debugger.sendCommand({tabId:e},"Emulation.setDefaultBackgroundColorOverride",t,a)}))}function enablePage(e){return new Promise((t=>{chrome.debugger.sendCommand({tabId:e},"Page.enable",{},(()=>{t(e)}))}))}function attach(e,t,a){return new Promise(((t,n)=>{"complete"===a.status&&chrome.debugger.attach({tabId:e},"1.0",(()=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(a||{id:e})}))}))}function detach(e){return new Promise((t=>{chrome.debugger.detach({tabId:e},(()=>{setTimeout((()=>{t(e)}),3e3)}))}))}function sleep(e){return new Promise((t=>setTimeout(t,e)))}async function captureArea(e,t){const a=await function(e){return new Promise((t=>{chrome.tabs.sendMessage(e.id,{key:"getDPR",data:{}},{frameId:0},(e=>{"number"==typeof e.dpr?t(e.dpr):t(1)}))}))}(e);t={x:t.x/a,y:t.y/a,width:t.width/a,height:t.height/a},await attach(e.id,0,e),await enablePage(e.id),await setBg(e.id,{color:{r:255,g:255,b:255,a:1}}),await sleep(3e3);const n=await screenshot(e.id,t);return await clearSize(e.id),await detach(e.id),await sleep(1e3),n}const T="$firefox$"===w.getNavigatorUserAgent(),y={query:e=>new Promise((t=>{chrome.tabs.query(e,(e=>{t(e)}))})),create:e=>(e.url||(e.url="about:blank"),new Promise((t=>{chrome.tabs.create(e,(e=>{t(e)}))}))),update:(e,t)=>new Promise((a=>{chrome.tabs.update(e,t,(e=>{a(e)}))})),get:e=>new Promise((t=>{chrome.tabs.get(e,(e=>{t(e)}))})),reload:()=>new Promise((e=>{y.getActiveTab().then((t=>{chrome.tabs.reload(t.id,{bypassCache:!0},(()=>{e(!0)}))}))})),stopLoad:()=>new Promise((e=>{y.getActiveTab().then((t=>{y.sendTabMessage(t.id,{key:"stopLoad",data:{key:"stopLoad",data:{}}}).then((t=>{e(t)}))}))})),goForward:()=>new Promise((e=>{y.getActiveTab().then((t=>{chrome.tabs.goForward(t.id,(()=>{e(!0)}))}))})),goBack:()=>new Promise((e=>{y.getActiveTab().then((t=>{chrome.tabs.goBack(t.id,(()=>{e(!0)}))}))})),remove:e=>new Promise((t=>{chrome.tabs.remove(e,(()=>{t(!0)}))})),getZoom:e=>new Promise((t=>{chrome.tabs.getZoom(e,(e=>{t(e)}))})),executeFuncOnFrame:(e,t,a,n)=>new Promise(((r,s)=>{chrome.scripting.executeScript({target:{tabId:e,frameIds:[t]},func:a,args:n,world:"ISOLATED"},(e=>{if(chrome.runtime.lastError)return s(new Error(chrome.runtime.lastError.message));e&&null!==e[0]?Array.isArray(e)&&1===e.length?r(e[0].result):s(new Error(`unknown error: fail to execute script on ${t}`)):s(new Error(`${a.toString()}executeFuncOnFrame error on frameId${t}`))}))})),executeScriptOnFrame:(e,t,a)=>new Promise(((n,r)=>{b.evaluate(e,a,t).then((e=>{n(e)})).catch((t=>{b.detachDebugger(e),r(t)}))})),runJS:(e,t,a)=>new Promise(((n,r)=>{if(T)y.sendTabFrameMessage(e,a,t).then((e=>{e.code===m.SUCCESS?n(e.data):r(new Error(e.msg||h.EXECUTE_ERROR))})).catch((e=>{r(e)}));else{const{code:s}=a.data;y.executeScriptOnFrame(e,t,s).then((e=>{n(e)}),(e=>{r(e)}))}})),getAllTabs:()=>new Promise((e=>{chrome.tabs.query({},(t=>{e(t)}))})),reloadAllTabs:()=>{y.getAllTabs().then((e=>{for(const t of e)t.url&&!t.url.startsWith("chrome://")&&chrome.tabs.reload(t.id)}))},urlGetTab:e=>new Promise(((t,a)=>{chrome.tabs.query({},(n=>{const r=n.find((t=>w.isEndWithSlash(t.url)&&!w.isEndWithSlash(e)?t.url===`${e}/`:t.url===e));r?y.activeTargetTab(r.id).then((e=>{t(e)})):a(new Error("no tab found"))}))})),getTab:e=>new Promise(((t,a)=>{try{y.getActiveTab().then((a=>{a.url===e?t(a):y.urlGetTab(e).then((e=>{t(e)}),(()=>{y.openTab(e).then((e=>{t(e)}))}))}))}catch(n){a(n)}})),getActiveTab:()=>new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(t=>{e(t[0])}))})),activeTargetTab:e=>new Promise((t=>{chrome.tabs.update(e,{active:!0},(e=>{t(e)}))})),activeTargetTabByTabUrl:e=>new Promise((t=>{chrome.tabs.query({url:e},(a=>{a&&a[0]?chrome.tabs.update(a[0].id,{active:!0,highlighted:!0,selected:!0},(e=>{t(e)})):chrome.tabs.create({url:e},(e=>{t(e)}))}))})),switchTab:(e,t,a)=>new Promise((n=>{a?y.activeTargetTab(a).then((e=>{n(e)})):chrome.tabs.query({url:e,title:t},(e=>{e&&e[0]?y.activeTargetTab(e[0].id).then((e=>{n(e)})):n(null)}))})),openTab:e=>new Promise((t=>{chrome.tabs.create({url:e},(e=>{t(e)}))})),closeTab:e=>new Promise((t=>{chrome.tabs.remove(e,(()=>{t(!0)}))})),excuteTabScript:(e,t)=>new Promise((a=>{chrome.tabs.executeScript(e,{code:t},(e=>{a(e)}))})),getAllFrames:e=>new Promise((t=>{chrome.webNavigation.getAllFrames({tabId:e},(a=>{const n=a.filter((e=>w.isSupportProtocal(e.url))),r=n.map(((t,a)=>{const r=[{frameId:t.frameId}];return y.executeFuncOnFrame(e,t.frameId,(e=>window.handleSync({key:"getFrameInfo",data:e})),r).then((e=>{if(0!==t.frameId){const{iframeXpath:r}=e;n[a]={...t,iframeXpath:r}}else n[a]={...t,iframeXpath:""}}))}));Promise.all(r).then((()=>t(n)))}))})),getExtFrames:e=>new Promise((t=>{chrome.webNavigation.getAllFrames({tabId:e},(e=>{t(e)}))})),sendTabFrameMessage:(e,t,a)=>new Promise(((n,r)=>{const s=setTimeout((()=>{r(new Error(`Message timeout: frameId ${a} not responding`))}),1e4);try{chrome.tabs.sendMessage(e,t,{frameId:a},(e=>{clearTimeout(s),chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):n(e)}))}catch(i){clearTimeout(s),r(i)}})),sendTabMessage:(e,t)=>new Promise((a=>{chrome.tabs.sendMessage(e,t,{},(e=>{a(e)}))})),sendMessage:e=>new Promise((t=>{y.getAllTabs().then((a=>{a.forEach((a=>{chrome.tabs.sendMessage(a.id,e,{},(e=>{t(e)}))}))}))})),getFramePosition:(e,t,a)=>new Promise((n=>{y.sendTabFrameMessage(e,{key:"getFramePosition",data:{url:a}},t).then((e=>{n(e)}))})),getUrl:()=>new Promise((e=>{y.getActiveTab().then((t=>{e(t.url)}))})),getTitle:()=>new Promise((e=>{y.getActiveTab().then((t=>{e(t.title)}))})),captureScreen:()=>new Promise((e=>{y.getActiveTab().then((t=>{chrome.tabs.captureVisibleTab(t.windowId,{format:"jpeg",quality:80},(t=>{e(t)}))}))})),capturePage:async()=>new Promise((e=>{y.getActiveTab().then((t=>{captureFullPage(t).then((t=>{e(t)}))}))})),captureElement:async e=>new Promise((t=>{y.getActiveTab().then((a=>{captureArea(a,e).then((e=>{t(e)}))}))})),resetZoom:e=>new Promise((t=>{chrome.tabs.setZoom(e,1,(()=>{t(!0)}))}))},WindowControl_getCurrent=()=>new Promise((e=>{chrome.windows.getCurrent(null,(t=>{e(t)}))})),WindowControl_update=(e,t)=>new Promise((a=>{chrome.windows.update(e,t,(e=>{a(e)}))}));async function getIframeElement(e,t){const a=await y.getActiveTab(),n=await y.getAllFrames(a.id),r=JSON.parse(JSON.stringify(t));let s=n.find((e=>e.frameId===t.frameId));const i=[];for(;s;)i.unshift(s.frameId),s=n.find((e=>e.frameId===s.parentFrameId));const c=await async function(e,t,a,n){const r=[];for(const s of t)try{const t=await y.executeFuncOnFrame(e.id,s,(e=>window.handleSync({key:"getIframeElement",data:e})),[a]);r.push(t);const{nextPos:n}=t;a.x=n.x,a.y=n.y}catch{return[n]}return r}(a,i,e,t);if(c.length>0){const e=c[c.length-1],a=e.xpath===t.xpath,n=e.url===t.url;return a&&n||(c[c.length-1]=r),c.forEach(((e,t)=>{r.iframeXpath=0===t?e.xpath:`${r.iframeXpath}/$iframe$${e.xpath}`,e.iframeContentRect&&(r.rect.x+=e.iframeContentRect.x,r.rect.y+=e.iframeContentRect.y)})),r.rect.left=r.rect.x,r.rect.top=r.rect.y,r.rect.right=r.rect.x+r.rect.width,r.rect.bottom=r.rect.y+r.rect.height,r.iframeXpath=r.iframeXpath.split("/$iframe$").slice(0,-1).join("/$iframe$"),r}return t}function findFrameByUrl(e,t){return e.find((e=>e.url.includes(t)))}function findFrameByXpath(e,t){if(!t||!Array.isArray(e)||0===e.length)return null;const a=t.split("/$iframe$").map((e=>e.trim())).filter(Boolean);if(0===a.length)return null;const n=e.find((e=>0===e.frameId));if(!n)return null;let r=n;for(const s of a){const t=e.find((e=>e.iframeXpath===s&&e.parentFrameId===r.frameId));if(!t)return null;r=t}return r}function adjustRectPosition(e,t){e.x+=t.x,e.y+=t.y,e.left=e.x,e.top=e.y,e.right=e.x+e.width,e.bottom=e.y+e.height}async function findTabAndFrame(e){const{url:t,iframeXpath:a,isFrame:n,tabUrl:r}=e.data;let s=await y.getActiveTab();if(!s&&(s=await y.activeTargetTabByTabUrl(r),!s))throw new Error(h.ACTIVE_TAB_ERROR);if(n){const e=await y.getAllFrames(s.id);log_info("frames: ",e);const n=a?findFrameByXpath(e,a):findFrameByUrl(e,t);return n?{tab:s,frameId:n.frameId}:{tab:s,frameId:Number.NaN}}return{tab:s,frameId:0}}globalThis.activeElement=null;const R={tabsHandler:()=>({async reloadTab(){const e=await y.reload();return w.success(e)},async stopLoad(){const e=await y.stopLoad();return w.success(e)},async openNewTab(e){const t=await y.create(e.data);return w.success(t)},async closeTab(e){let t,{url:a,id:n}=e.data;if(n&&"number"!=typeof n){try{if(n=Number.parseInt(n,10),Number.isNaN(n))return w.fail(h.NUMBER_ID_ERROR)}catch{return w.fail(h.NUMBER_ID_ERROR)}return await y.remove(n),w.success(!0)}return a&&(t=await y.getTab(a)),t||(t=await y.getActiveTab()),t?(await y.remove(t.id),w.success(!0)):w.fail("tab not found")},async updateTab(e){const{url:t}=e.data,a=await y.getActiveTab();return a?(await y.update(a.id,{url:t}),w.success(!0)):w.fail("tab not found")},async activeTab(e){const{url:t}=e.data,a=await y.getTab(t);return await y.activeTargetTab(a.id),w.success(!0)},async getActiveTab(){const e=await y.getActiveTab();return e?w.success(e):w.fail(h.ACTIVE_TAB_ERROR)},async switchTab(e){let{url:t,title:a,id:n}=e.data;if(n&&"number"!=typeof n)try{if(n=Number.parseInt(n,10),Number.isNaN(n))return w.fail(h.NUMBER_ID_ERROR)}catch{return w.fail(h.NUMBER_ID_ERROR)}const r=await y.switchTab(t,a,n);return r?w.success(r):w.fail(h.TAB_GET_ERROR)},async getAllTabs(){const e=await y.getAllTabs();return w.success(e)},async backward(){const e=await y.goBack();return w.success(e)},async forward(){const e=await y.goForward();return w.success(e)},async maxWindow(){const e=await WindowControl_getCurrent();if(await WindowControl_update(e.id,{state:"maximized"}))return w.success(!0);const{lastError:t}=chrome.runtime;return t?w.fail(t.message,m.EXECUTE_ERROR):void 0},async minWindow(){const e=await WindowControl_getCurrent();if(await WindowControl_update(e.id,{state:"minimized"}))return w.success(!0);const{lastError:t}=chrome.runtime;return t?w.fail(t.message,m.EXECUTE_ERROR):void 0},async executeScriptOnFrame(e){const{url:t,code:a}=e.data,n=await y.getActiveTab();if(!n)return w.fail(h.ACTIVE_TAB_ERROR);const r=(await y.getAllFrames(n.id)).find((e=>e.url===t)),s=r?r.frameId:0,i=await y.executeScriptOnFrame(n.id,s,a);return w.success(i)},async getTitle(){const e=await y.getTitle();return w.success(e)},async getUrl(){const e=await y.getUrl();return w.success(e)},async captureScreen(){const e=await y.captureScreen();if(e)return w.success(e)},async capturePage(){const e=await y.capturePage();if(e)return w.success(e)},async loadComplete(){const{lastError:e}=chrome.runtime,t=await y.getActiveTab();return t?e?w.fail(e.message,m.EXECUTE_ERROR):"complete"===t.status?w.success(!0):w.success(!1):w.fail(h.ACTIVE_TAB_ERROR)},async getFrames(){const e=await y.getActiveTab();if(!e)return w.fail(h.ACTIVE_TAB_ERROR);return await y.getAllFrames(e.id)},async getExtFrames(){const e=await y.getActiveTab();if(!e)return w.fail(h.ACTIVE_TAB_ERROR);return await y.getExtFrames(e.id)},async resetZoom(){const e=await y.getActiveTab();if(!e)return w.fail(h.ACTIVE_TAB_ERROR);return await y.resetZoom(e.id)},async getTabId(){const e=await y.getActiveTab();return e?w.success(e.id):w.fail(h.ACTIVE_TAB_ERROR)}}),elementHandler:()=>({async getElement(e){const t=globalThis.activeElement;if(t&&t.isFrame){const{x:a,y:n}=e.data;if(!a||!n)return w.success(t);const r=await getIframeElement({x:a,y:n},t);return w.success(r)}return w.success(t)},async getOuterHTML(e){try{const t=await R.elementHandler().getElement(e);e.data=t?.data||globalThis.activeElement;const{tab:a,frameId:n}=await findTabAndFrame({...e}),r=await y.sendTabFrameMessage(a.id,e,n),s={...e.data,...r.data};return w.success(s)}catch(t){console.log("ignore getOuterHTML error: ",t);const e=globalThis.activeElement;return w.success(e)}},async handleInContent(e){const{tab:t,frameId:a}=await findTabAndFrame(e);if(Number.isNaN(a))return w.fail(h.FRAME_GET_ERROR,m.ELEMENT_NOT_FOUND);if(!w.isSupportProtocal(t.url))return w.fail(`${t.url} ${h.CURRENT_TAB_UNSUPPORT_ERROR}`);const n=await y.sendTabFrameMessage(t.id,e,a);return null===n?w.fail(h.CONTENT_MESSAGE_ERROR,m.UNKNOWN_ERROR):n.code!==m.SUCCESS?w.fail(n.msg,n.code):w.success(n.data)},async getElementPos(e){const{url:t,isFrame:a,iframeXpath:n,tabUrl:r}=e.data;let s=await y.getActiveTab();if(s||(s=await y.activeTargetTabByTabUrl(r)),!w.isSupportProtocal(s.url))return w.fail(`${s.url} ${h.CURRENT_TAB_UNSUPPORT_ERROR}`);if(!a){const t=await y.sendTabFrameMessage(s.id,e,0);return w.result(t.data,t.msg,t.code)}const i=await y.getAllFrames(s.id),c=n?findFrameByXpath(i,n):findFrameByUrl(i,t);if(!c)return w.fail(h.FRAME_GET_ERROR,m.ELEMENT_NOT_FOUND);const o=function(e,t){const a=[];for(;t;)a.unshift(t),t=e.find((e=>e.frameId===t.parentFrameId));return a}(i,c),l=await async function(e,t){const a=t.slice(0,-1).map(((a,n)=>{const r=t[n+1],s=[{iframeXpath:r.iframeXpath,url:r.url}];return y.executeFuncOnFrame(e,a.frameId,(e=>window.handleSync({key:"getFramePosition",data:e})),s)}));return(await Promise.all(a)).reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e)),{x:0,y:0})}(s.id,o),d=await y.sendTabFrameMessage(s.id,e,c.frameId);return d.code!==m.SUCCESS?w.fail(d.msg,d.code):(function(e,t){Array.isArray(e)?e.forEach((e=>adjustRectPosition(e,t))):adjustRectPosition(e,t)}(d.data.rect,l),w.success(d.data))},checkElement:async e=>await R.elementHandler().getElementPos(e),async scrollIntoView(e){if(e.data?.openSourcePage){const t=await y.getActiveTab();t&&t.url===e.data.tabUrl||await y.openTab(e.data.url)}return await R.elementHandler().handleInContent(e)},async similarElement(e){let t=globalThis.activeElement;const{tabUrl:a}=e.data;let n=await y.getActiveTab();if(!n)return w.fail(h.ACTIVE_TAB_ERROR);n.url!==a&&(n=await y.getTab(a));try{if(!function(e,t){if(!e||!t)return!1;if(0===e.length||0===t.length)return!1;const a=e[0],n=t[0],r=a.attrs.find((e=>"id"===e.name&&e.checked&&""!==e.value)),s=n.attrs.find((e=>"id"===e.name&&e.checked&&""!==e.value));return r&&s?r.value===s.value:!r&&!s}(e.data.pathDirs,t.pathDirs)){const a=await R.elementHandler().handleInContent({...e,key:"reSimilarElement",data:{...t,preData:e.data}});log_info("reSimilarElement result: ",a),a.data&&(e.data=a.data.preData,t=a.data,delete e.data.preData)}const a=getSimilarElement(e.data,t);if(a){const t=await R.elementHandler().handleInContent({...e,data:a});return a.similarCount=t.data?.similarCount||0,w.success(a)}return w.fail(h.NOT_SIMILAR_ELEMENT,m.ELEMENT_NOT_FOUND)}catch(r){return w.fail(r.toString(),m.EXECUTE_ERROR)}},elementFromSelect:async e=>await R.elementHandler().handleInContent(e),async elementIsRender(e){const{tab:t,frameId:a}=await findTabAndFrame(e);if(Number.isNaN(a))return w.success(!1);const n=await y.sendTabFrameMessage(t.id,e,a);return n?w.success(n.data):w.success(!1)},async elementIsReady(e){const t=await y.getActiveTab(),{tab:a,frameId:n}=await findTabAndFrame(e);if(Number.isNaN(n))return w.success(!1);const r=await y.sendTabFrameMessage(a.id,e,n),s="complete"===t.status;return r?w.success(r.data&&s):w.success(!1)},async elementIsTable(e){e.data.xpath||(e.data=globalThis.activeElement);const t={isTable:!!(await R.elementHandler().handleInContent(e)).data,...e.data};return w.success(t)},async tableDataBatch(e){"xpath"in e.data||(e.data=globalThis.activeElement);const t=await R.elementHandler().handleInContent(e),a=t.data?.values||[],n=new f(t.data,a,"table").getTable();return w.success(n)},async tableColumnDataBatch(e){"xpath"in e.data||(e.data=globalThis.activeElement);const t=await R.elementHandler().handleInContent(e),a=t.data?.value||[],n=new f(t.data,a,"similar").getTable();return w.success(n)},async similarBatch(e){if("xpath"in e.data||(e.data=globalThis.activeElement),"batchType"in e.data&&["similar","similarAdd"].includes(e.data.batchType)){const t=await R.elementHandler().similarElement(e);if(t.code!==m.SUCCESS)return t;e.data=t.data}const t=await R.elementHandler().handleInContent(e),a=t.data?.value||[],n=new f(t.data,a,"similar").getTable();return w.success(n)},async tableHeaderBatch(e){"xpath"in e.data||(e.data=globalThis.activeElement);return await R.elementHandler().handleInContent(e)},simalarListBatch:async e=>await R.elementHandler().handleInContent(e),highLightColumn:async e=>await R.elementHandler().handleInContent(e),async getBatchData(e){if(e.data?.openSourcePage){const t=await y.getActiveTab();t&&t.url===e.data.tabUrl||await y.openTab(e.data.tabUrl)}if(await w.wait(3),e.data&&"similar"===e.data.produceType){e.key="simalarListBatch";return await R.elementHandler().simalarListBatch(e)}e.key="tableDataBatch";return await R.elementHandler().tableDataBatch(e)},async elementShot(e){e.key="scrollToTop",await R.elementHandler().scrollToTop(e),await R.tabsHandler().resetZoom(),e.key="getElementPos";const t=await R.elementHandler().getElementPos(e),{x:a,y:n,width:r,height:s}=t.data?.rect,i=await y.captureElement({x:a,y:n,width:r,height:s});return w.success(i)},async scrollToTop(e){const t=await R.elementHandler().handleInContent(e);return w.success(t)},async getSimilarIterator(e){e.key="elementFromSelect";const t=e.data?.index||0,a=e.data?.count||1,n=await R.elementHandler().elementFromSelect(e);if(n.data&&Array.isArray(n.data)){if(t<n.data.length){let e=[n.data[t]];return e=t+a<=n.data.length?n.data.slice(t,t+a):n.data.slice(t),e=e.map(((e,t)=>(e.index+=t,{...e,similarCount:n.data.length}))),w.success(e)}return w.success([])}return w.fail(h.SIMILAR_NOT_FOUND,m.ELEMENT_NOT_FOUND)},async getRelativeElement(e){const{relativeOptions:t}=e.data;if(!t)return w.fail(h.RELATIVE_ELEMENT_PARAMS_ERROR);return await R.elementHandler().handleInContent(e)},async generateElement(e){const t=await y.getActiveTab();if(!t)return w.fail(h.ACTIVE_TAB_ERROR);return await y.sendTabFrameMessage(t.id,e,0)},getParentElement:async e=>await R.elementHandler().handleInContent(e),getChildElement:async e=>await R.elementHandler().handleInContent(e),clickElement:async e=>await R.elementHandler().handleInContent(e),inputElement:async e=>await R.elementHandler().handleInContent(e),getElementText:async e=>await R.elementHandler().handleInContent(e),getElementAttrs:async e=>await R.elementHandler().handleInContent(e),removeElementAttr:async e=>await R.elementHandler().handleInContent(e),setElementAttr:async e=>await R.elementHandler().handleInContent(e),getElementChecked:async e=>await R.elementHandler().handleInContent(e),setElementChecked:async e=>await R.elementHandler().handleInContent(e),getElementSelected:async e=>await R.elementHandler().handleInContent(e),setElementSelected:async e=>await R.elementHandler().handleInContent(e),getTableData:async e=>await R.elementHandler().handleInContent(e),scrollWindow:async e=>await R.elementHandler().handleInContent(e)}),jsHandler:()=>({async runJS(e){const{tab:t,frameId:a}=await findTabAndFrame(e);if(Number.isNaN(a))return w.fail(h.FRAME_GET_ERROR,m.ELEMENT_NOT_FOUND);await y.getAllFrames(t.id);try{const n=await y.runJS(t.id,a,e);return w.success(n)}catch(n){return w.fail(n.toString(),m.EXECUTE_ERROR)}}}),cookieHandler:()=>({..._}),otherHandler:()=>({currentExtension:()=>new Promise((e=>{chrome.management.getSelf((t=>{e(t)}))})),backgroundInject:()=>w.success(!0),contentInject:()=>w.success(!0)}),noHandler:()=>w.fail(h.UNSUPPORT_ERROR)};function reloadAllTabs(){new Promise((e=>{chrome.tabs.query({},(t=>{e(t)}))})).then((e=>{for(const t of e)chrome.tabs.reload(t.id)}))}function disableOldExtensions(){new Promise((e=>{chrome.management.getAll((t=>{log_info("Installed extensions:",t),e(t)}))})).then((e=>{e.forEach((e=>{"dibfknoajiboamheempfppeapcedplgm"!==e.id&&"gfpcfabhkgenjcmjgnldmkhjieekeeea"!==e.id||chrome.management.setEnabled(e.id,!1)}))}))}chrome.runtime.onMessage.addListener(((e,t,a)=>(function(e,t){if("element"===e.type&&t.tab){const a={tabTitle:t.tab.title,tabUrl:t.tab.url,isFrame:0!==t.frameId,frameId:t.frameId};globalThis.activeElement={...e.data,...a}}}(e,t),!0))),chrome.runtime.onInstalled.addListener((()=>{reloadAllTabs(),disableOldExtensions(),chrome.alarms.create("weakAlarm",{delayInMinutes:1,periodInMinutes:1})})),chrome.runtime.onStartup.addListener((()=>{reloadAllTabs()})),chrome.management.onEnabled.addListener((e=>{e.id===chrome.runtime.id&&(reloadAllTabs(),disableOldExtensions(),chrome.alarms.create("weakAlarm",{delayInMinutes:1,periodInMinutes:1}))})),chrome.alarms.onAlarm.addListener((e=>{"weakAlarm"===e.name&&log_info("Alive alarm triggered")})),async function(){const e=await createWsApp();e.start(),e.event("browser","",(t=>{const a=t.to_reply();(async function(e){const t="string"==typeof e?JSON.parse(e):e;log_info(t.key,t),log_time(t.key);const a=await async function(e){let t=null;const{key:a}=e,n=R;try{return n[a]?(t=await n[a](e),t):n.tabsHandler()[a]?(t=await n.tabsHandler()[a](e),t):n.elementHandler()[a]?(e.data&&"produceType"in e.data&&"similar"===e.data.produceType&&(e.data={...e.data,...e.data.values[0]}),t=await n.elementHandler()[a](e),t):n.jsHandler()[a]?(t=await n.jsHandler()[a](e),t):n.cookieHandler()[a]?(t=await n.cookieHandler()[a](e.data),t):n.otherHandler()[a]?(t=await n.otherHandler()[a](e.data),t):(t=n.noHandler(),t)}catch(r){return w.fail(r.toString(),m.EXECUTE_ERROR)}}(t);return log_timeEnd(t.key),log_info(t.key,a),a})(t).then((t=>{a.data=t,e.send(a)}))}))}();
